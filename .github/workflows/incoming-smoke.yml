name: Incoming CLI smoke

on:
  workflow_dispatch:
    inputs:
      data-root:
        description: Percorso relativo alla cartella dati decompressa (default incoming/decompressed/latest/data)
        required: false
      pack-root:
        description: Percorso relativo alla directory del pack ecosistemi (default incoming/decompressed/latest/packs/evo_tactics_pack)
        required: false
  pull_request:
    paths:
      - 'incoming/**'
      - 'docs/incoming/**'
      - 'scripts/cli_smoke.sh'
      - 'config/cli/staging_incoming.yaml'
      - '.github/workflows/incoming-smoke.yml'

permissions:
  contents: read
  actions: write

concurrency:
  group: incoming-smoke-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: tools/py
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt

      - name: Resolve incoming asset paths
        id: paths
        run: |
          set -euo pipefail
          data_input="${{ github.event.inputs.data-root }}"
          pack_input="${{ github.event.inputs.pack-root }}"
          default_data="incoming/decompressed/latest/data"
          default_pack="incoming/decompressed/latest/packs/evo_tactics_pack"
          if [[ -z "${data_input}" ]]; then
            data_input="${default_data}"
          fi
          if [[ -z "${pack_input}" ]]; then
            pack_input="${default_pack}"
          fi
          echo "data_root=${GITHUB_WORKSPACE}/${data_input}" >> "${GITHUB_OUTPUT}"
          echo "pack_root=${GITHUB_WORKSPACE}/${pack_input}" >> "${GITHUB_OUTPUT}"

      - name: Run incoming smoke profile
        env:
          CLI_PROFILES: staging_incoming
          GAME_CLI_INCOMING_DATA_ROOT: ${{ steps.paths.outputs.data_root }}
          GAME_CLI_INCOMING_PACK_ROOT: ${{ steps.paths.outputs.pack_root }}
        run: |
          set -euo pipefail
          ./scripts/cli_smoke.sh --profile "${CLI_PROFILES}"

      - name: Upload incoming smoke logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: incoming-smoke-logs
          path: logs/incoming_smoke
