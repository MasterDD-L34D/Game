name: Log harvester

on:
  schedule:
    - cron: '0 3 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  harvest:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.CI_LOG_PAT }}
      CI_LOG_CONFIG_FILE: ops/ci-log-config.txt
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate GH_TOKEN
        run: |
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "::error::GH_TOKEN non impostato: definisci il secret CI_LOG_PAT con scope workflow/read:org/repo-admin"
            exit 1
          fi

      - name: Auth gh
        run: |
          set -eo pipefail
          printf '%s' "$GH_TOKEN" | gh auth login --with-token
          gh auth status
          gh auth setup-git

      - name: Inspect harvest config
        env:
          CONFIG_FILE: ${{ env.CI_LOG_CONFIG_FILE }}
        run: |
          set -eo pipefail
          config_file="${CONFIG_FILE:-ops/ci-log-config.txt}"
          if [ -f "$config_file" ]; then
            echo "Using config file: $config_file"
            grep -v '^#' "$config_file" | sed 's/^/- /'
          else
            echo "::warning::Config file $config_file not found; the script will fall back to its built-in list"
          fi

      - name: Run harvest script (punto 3)
        env:
          CI_LOG_HARVEST_CONFIG: ${{ env.CI_LOG_CONFIG_FILE }}
        run: |
          set -eo pipefail
          chmod +x scripts/ci_log_harvest.sh
          scripts/ci_log_harvest.sh

      - name: Commit harvested logs if updated
        id: commit
        run: |
          set -eo pipefail
          if [ -z "$(git status --porcelain=1 logs)" ]; then
            echo "changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          branch="log-harvest-$(date +%Y%m%d%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$branch"
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add logs
          git commit -m "chore: harvest ci logs"
          git push origin "$branch"

          echo "changes=true" >> "$GITHUB_OUTPUT"
          echo "branch=$branch" >> "$GITHUB_OUTPUT"

      - name: Upload logs bundle
        if: steps.commit.outputs.changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: logs-bundle
          path: logs

      - name: Package logs archive
        id: package
        run: |
          set -eo pipefail
          archive_name="logs-harvest-$(date -u +%Y%m%d).zip"
          echo "Archive name: ${archive_name}"
          zip -qr "$archive_name" logs
          echo "archive_name=${archive_name}" >> "$GITHUB_OUTPUT"

      - name: Publish logs archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.package.outputs.archive_name }}
          path: ${{ steps.package.outputs.archive_name }}
          retention-days: 14
