name: CI

on:
  push:
  pull_request:

jobs:
  paths-filter:
    runs-on: ubuntu-latest
    outputs:
      ts: ${{ steps.filter.outputs.ts }}
      cli: ${{ steps.filter.outputs.cli }}
      python: ${{ steps.filter.outputs.python }}
      data: ${{ steps.filter.outputs.data }}
      deploy: ${{ steps.filter.outputs.deploy }}
      styleguide: ${{ steps.filter.outputs.styleguide }}
      stack: ${{ steps.filter.outputs.stack }}
      site_audit: ${{ steps.filter.outputs.site_audit }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: filter
        name: Detect impacted areas
        uses: dorny/paths-filter@v3
        with:
          filters: |
            ts:
              - 'package.json'
              - 'package-lock.json'
              - 'tools/ts/**'
              - 'webapp/package.json'
              - 'webapp/package-lock.json'
              - 'webapp/src/**'
            cli:
              - 'scripts/cli_smoke.sh'
              - 'tools/py/game_cli.py'
              - 'tools/py/game_cli/**'
            python:
              - 'scripts/**/*.py'
              - 'server/**/*.py'
              - 'services/**/*.py'
              - 'tests/**/*.py'
              - 'tools/py/**'
            data:
              - 'data/**'
              - 'packs/**'
              - 'reports/**'
            deploy:
              - 'scripts/trait_audit.py'
              - 'scripts/run_deploy_checks.sh'
              - 'tools/py/report_trait_coverage.py'
              - 'config/deploy/**'
            styleguide:
              - 'tools/py/styleguide_compliance_report.py'
              - 'tools/py/styleguide_utils.py'
              - 'logs/qa/latest-dashboard-metrics.json'
              - 'reports/styleguide_compliance.*'
              - 'scripts/cron/traits_monthly_maintenance.sh'
              - '.github/workflows/traits-monthly-maintenance.yml'
            stack:
              - 'package.json'
              - 'package-lock.json'
              - 'Makefile'
              - 'scripts/dev-stack.sh'
              - 'scripts/lint-stack.mjs'
              - 'server/**'
              - 'services/**/*.js'
              - 'tests/**/*.js'
              - 'webapp/**'
              - 'Trait Editor/**'
            site_audit:
              - 'ops/site-audit/**'
              - 'Makefile'

  playwright-bundle:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.deploy == 'true'
    outputs:
      sha256: ${{ steps.chromium_meta.outputs.sha256 }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tools/ts/package-lock.json

      - name: Install TypeScript tool dependencies
        working-directory: tools/ts
        run: npm ci --no-audit --no-fund

      - name: Prepare Chromium cache
        working-directory: tools/ts
        env:
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/playwright-browsers
        run: node ./scripts/prepare_playwright.mjs

      - name: Archive Chromium bundle
        id: chromium_meta
        env:
          PLAYWRIGHT_BUNDLE_DIR: ${{ runner.temp }}/playwright-browsers
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          BUNDLE_DIR="$PLAYWRIGHT_BUNDLE_DIR"
          if [ ! -d "$BUNDLE_DIR" ]; then
            echo "Chromium bundle non disponibile in $BUNDLE_DIR" >&2
            exit 1
          fi
          if ! ls "$BUNDLE_DIR"/chromium-* >/dev/null 2>&1; then
            echo "Bundle Chromium assente nella cache Playwright" >&2
            exit 1
          fi
          tar -czf "$RUNNER_TEMP/chromium-bundle.tar.gz" -C "$BUNDLE_DIR" .
          SHA=$(sha256sum "$RUNNER_TEMP/chromium-bundle.tar.gz" | cut -d ' ' -f1)
          echo "sha256=$SHA" >> "$GITHUB_OUTPUT"
          echo "archive=$RUNNER_TEMP/chromium-bundle.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Upload Chromium bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: playwright-chromium-bundle
          path: ${{ steps.chromium_meta.outputs.archive }}
          retention-days: 5

  generator-dashboard-validation:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
      - playwright-bundle
    if: needs.paths-filter.outputs.deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Validate generator dashboard
        run: |
          python tests/validate_dashboard.py --metrics-output logs/qa/dashboard_ci_metrics.json --no-log

      - name: Upload dashboard metrics
        uses: actions/upload-artifact@v4
        with:
          name: generator-dashboard-metrics
          path: logs/qa/dashboard_ci_metrics.json
          if-no-files-found: error

  typescript-tests:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.ts == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node.js dependencies
        run: npm ci --workspace tools/ts --include-workspace-root false

      - name: Run TypeScript tests
        working-directory: tools/ts
        run: npm test

      - name: Validate Species (TS)
        working-directory: tools/ts
        run: node dist/validate_species.js ../../data/core/species.yaml

  webapp-quality:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.ts == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install workspace dependencies
        run: npm ci

      - name: Run workspace lint checks
        run: npm run lint:stack

      - name: Run webapp unit tests
        run: npm run test --workspace webapp

      - name: Build webapp with relative base
        env:
          VITE_BASE_PATH: ./
        run: npm run build --workspace webapp

      - name: Smoke preview build
        env:
          VITE_BASE_PATH: ./
        run: |
          npm run preview --workspace webapp -- --host 127.0.0.1 --port 4173 --strictPort &
          PREVIEW_PID=$!
          trap 'kill $PREVIEW_PID' EXIT
          npx wait-on http://127.0.0.1:4173
          curl --fail http://127.0.0.1:4173 >/tmp/webapp-preview.html

  stack-quality:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.stack == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install workspace dependencies
        run: npm ci

      - name: Lint stack
        run: npm run lint:stack

      - name: Run backend API tests
        run: npm run test:api

      - name: Run frontend unit tests
        run: npm run test --workspace webapp

      - name: Install Trait Editor dependencies
        working-directory: Trait Editor
        run: npm ci --no-audit --no-fund

      - name: Run Trait Editor unit tests
        working-directory: Trait Editor
        run: npm run test

      - name: Build Trait Editor
        working-directory: Trait Editor
        run: npm run build

      - name: Build frontend for production
        env:
          VITE_BASE_PATH: ./
        run: npm run build --workspace webapp

  site-audit:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.site_audit == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install site audit dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement ops/site-audit/requirements.txt

      - name: Resolve SITE_BASE_URL
        run: |
          if [ -n "${{ vars.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ vars.SITE_BASE_URL }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ secrets.SITE_BASE_URL }}" >> $GITHUB_ENV
          else
            echo "SITE_BASE_URL=" >> $GITHUB_ENV
          fi

      - name: Run site audit suite
        if: env.SITE_BASE_URL != ''
        env:
          SITE_BASE_URL: ${{ env.SITE_BASE_URL }}
        run: make audit

      - name: Skip site audit (missing SITE_BASE_URL)
        if: env.SITE_BASE_URL == ''
        run: echo "SITE_BASE_URL not configured; skipping site audit checks."

      - name: Upload site audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-audit
          path: ops/site-audit/_out
          if-no-files-found: warn

  lighthouse-ci:
    runs-on: ubuntu-latest
    needs: paths-filter
    if: needs.paths-filter.outputs.stack == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm i -g @lhci/cli@0.13.x

      - name: Resolve SITE_BASE_URL
        run: |
          if [ -n "${{ vars.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ vars.SITE_BASE_URL }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ secrets.SITE_BASE_URL }}" >> $GITHUB_ENV
          else
            echo "SITE_BASE_URL=" >> $GITHUB_ENV
          fi

      - name: Run Lighthouse CI
        if: env.SITE_BASE_URL != ''
        env:
          SITE_BASE_URL: ${{ env.SITE_BASE_URL }}
        run: lhci autorun --config=./lighthouserc.json

      - name: Skip Lighthouse CI (missing SITE_BASE_URL)
        if: env.SITE_BASE_URL == ''
        run: echo "SITE_BASE_URL not configured; skipping Lighthouse CI run."

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: ./.lighthouseci
          if-no-files-found: warn

  cli-checks:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: needs.paths-filter.outputs.cli == 'true' || needs.paths-filter.outputs.data == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tools/ts/package-lock.json

      - name: Install Node.js dependencies
        working-directory: tools/ts
        run: npm ci

      - name: Build TypeScript artifacts
        working-directory: tools/ts
        run: npm run build --silent

      - name: Run TypeScript CLI
        working-directory: tools/ts
        run: node dist/roll_pack.js ENTP invoker ../../data/packs.yaml

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: tools/py
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt

      - name: Validate base datasets (CLI)
        working-directory: tools/py
        run: python3 game_cli.py validate-datasets

      - name: Validate Evo-Tactics ecosystem pack
        run: python3 tools/py/game_cli.py validate-ecosystem-pack --json-out /tmp/evo_pack_report.json

      - name: Run CLI smoke profiles
        run: ./scripts/cli_smoke.sh

  python-tests:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: needs.paths-filter.outputs.python == 'true' || needs.paths-filter.outputs.data == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: tools/py
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt

      - name: Run pytest
        run: pytest

      - name: Validate Species (Python)
        working-directory: tools/py
        run: |
          python3 validate_species.py ../../data/core/species.yaml

      - name: Run Python validation script
        working-directory: tools/py
        run: python roll_pack.py ENTP invoker ../../data/packs.yaml

  dataset-checks:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: needs.paths-filter.outputs.data == 'true' || needs.paths-filter.outputs.deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: package-lock.json

      - name: Install Node.js dependencies
        run: npm ci

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: tools/py
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt

      - name: Audit trait catalog consistency
        run: python3 scripts/trait_audit.py --check

      - name: Regenerate trait baseline
        run: |
          python3 tools/py/build_trait_baseline.py \
            packs/evo_tactics_pack/docs/catalog/env_traits.json \
            packs/evo_tactics_pack/docs/catalog/trait_reference.json \
            --trait-glossary data/core/traits/glossary.json \
            --out data/derived/analysis/trait_baseline.yaml

      - name: Regenerate trait coverage reports
        run: |
          python3 tools/py/report_trait_coverage.py \
            --env-traits packs/evo_tactics_pack/docs/catalog/env_traits.json \
            --trait-reference packs/evo_tactics_pack/docs/catalog/trait_reference.json \
            --species-root packs/evo_tactics_pack/data/species \
            --trait-glossary data/core/traits/glossary.json \
            --out-json data/derived/analysis/trait_coverage_report.json \
            --out-csv data/derived/analysis/trait_coverage_matrix.csv
          python3 - <<'PY'
          import json, sys

          with open('data/derived/analysis/trait_coverage_report.json', encoding='utf-8') as handle:
              summary = json.load(handle).get('summary', {})

          min_traits = 27
          max_missing = 0

          traits_with_species = summary.get('traits_with_species')
          rules_missing = summary.get('rules_missing_species_total')

          errors: list[str] = []
          if traits_with_species is None or traits_with_species < min_traits:
              errors.append(f"traits_with_species={traits_with_species!r} sotto la soglia {min_traits}")
          if rules_missing is None or rules_missing > max_missing:
              errors.append(f"rules_missing_species_total={rules_missing!r} eccede il massimo consentito {max_missing}")

          if errors:
              print("\n".join(errors))
              sys.exit(1)
          PY

      - name: Generate trait completion dashboard
        run: |
          python3 tools/py/trait_completion_dashboard.py \
            --trait-reference data/traits/index.json \
            --out-markdown reports/trait_progress.md \
            --history-file logs/trait_audit/trait_progress_history.json

      - name: Run trait style guide check
        run: |
          mkdir -p reports/trait_style
          node scripts/trait_style_check.js \
            --output-json reports/trait_style/ci_trait_style_report.json \
            --output-markdown reports/trait_style/ci_trait_style_report.md \
            --fail-on error

      - name: Refresh release status report
        run: node tools/deploy/generateStatusReport.js --status reports/status.json

      - name: Upload trait style guide report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trait-style-report-${{ github.run_id }}
          path: |
            reports/trait_style/ci_trait_style_report.json
            reports/trait_style/ci_trait_style_report.md
          if-no-files-found: warn

  site-audit:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: >-
      needs.paths-filter.outputs.site_audit == 'true' ||
      needs.paths-filter.outputs.deploy == 'true' ||
      needs.paths-filter.outputs.stack == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Resolve SITE_BASE_URL
        run: |
          if [ -n "${{ vars.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ vars.SITE_BASE_URL }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ secrets.SITE_BASE_URL }}" >> $GITHUB_ENV
          else
            echo "SITE_BASE_URL=" >> $GITHUB_ENV
          fi

      - name: Install site audit dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement ops/site-audit/requirements.txt

      - name: Run site audit checks
        run: |
          if [ -z "$SITE_BASE_URL" ]; then
            echo "SITE_BASE_URL not configured; skipping site audit." >&2
            exit 0
          fi
          mkdir -p ops/site-audit/_out
          make audit SITE_BASE_URL="$SITE_BASE_URL"

      - name: Upload site audit artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-audit
          path: ops/site-audit/_out
          if-no-files-found: warn

  lighthouse-ci:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: >-
      needs.paths-filter.outputs.ts == 'true' ||
      needs.paths-filter.outputs.deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Lighthouse CI
        run: npm i -g @lhci/cli@0.13.x

      - name: Resolve SITE_BASE_URL
        run: |
          if [ -n "${{ vars.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ vars.SITE_BASE_URL }}" >> $GITHUB_ENV
          elif [ -n "${{ secrets.SITE_BASE_URL }}" ]; then
            echo "SITE_BASE_URL=${{ secrets.SITE_BASE_URL }}" >> $GITHUB_ENV
          else
            echo "SITE_BASE_URL=" >> $GITHUB_ENV
          fi

      - name: Run Lighthouse CI (remote)
        run: |
          if [ -z "$SITE_BASE_URL" ]; then
            echo "SITE_BASE_URL not configured; skipping Lighthouse audit." >&2
            exit 0
          fi
          lhci autorun --config=./lighthouserc.json

      - name: Upload Lighthouse artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: ./.lighthouseci
          if-no-files-found: warn

  styleguide-compliance:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
    if: >-
      needs.paths-filter.outputs.styleguide == 'true'
      || needs.paths-filter.outputs.data == 'true'
      || needs.paths-filter.outputs.python == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements-dev.txt ]; then
            pip install -r requirements-dev.txt
          fi

      - name: Generate styleguide compliance report
        run: python tools/py/styleguide_compliance_report.py --strict

      - name: Upload styleguide artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: styleguide-compliance-${{ github.run_id }}
          path: |
            reports/styleguide_compliance.json
            reports/styleguide_compliance.md
            logs/trait_audit/styleguide_compliance_history.json
          if-no-files-found: warn

  deployment-checks:
    runs-on: ubuntu-latest
    needs:
      - paths-filter
      - playwright-bundle
    if: needs.paths-filter.outputs.deploy == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: tools/ts/package-lock.json

      - name: Install Node.js dependencies
        working-directory: tools/ts
        run: npm ci

      - name: Build TypeScript artifacts
        working-directory: tools/ts
        run: npm run build --silent

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        working-directory: tools/py
        run: |
          python -m pip install --upgrade pip
          python -m pip install --requirement requirements.txt

      - name: Download Chromium bundle artifact
        uses: actions/download-artifact@v4
        with:
          name: playwright-chromium-bundle
          path: ${{ runner.temp }}/playwright-bundle

      - name: Run deploy validation checks
        env:
          DEPLOY_DATA_DIR: ${{ github.workspace }}/data
          CI: 'true'
          PLAYWRIGHT_REUSE_SERVER: '0'
          DEPLOY_SKIP_SMOKE_TEST: '1'
          PLAYWRIGHT_BROWSERS_PATH: ${{ runner.temp }}/playwright-browsers
          DEPLOY_CHROMIUM_BUNDLE_ARCHIVE: ${{ runner.temp }}/playwright-bundle/chromium-bundle.tar.gz
          DEPLOY_CHROMIUM_BUNDLE_SHA256: ${{ needs.playwright-bundle.outputs.sha256 }}
        run: scripts/run_deploy_checks.sh
